# kotlin コルーチン

コルーチンによって、処理の中で中断と再開ができるようになった。
これによって、並列で複数の処理を行いたいとき別のコルーチンでそれぞれの処理を行うことができる。

kotlinのコルーチンは、1スレッド上で複数動作するため非常に軽量。

コルーチンは、コルーチンビルダー関数で起動する。
コルーチンをブロッキングで使用する場合は、runBlockingを使う。
コルーチンスコープは子コルーチンの完了を待つ。

コルーチンの中で共有する要素のセットを実行コンテキストと呼ぶ。
中には、Job、コルーチンインターセプターなどがある。

コルーチンインターセプターの実装がコルーチンディスパッチャー。
コルーチンでどのスレッドで実行するかを選択できる。
定数で4種類提供している。
- Main: メインスレッドを使用する。
- IO: メインスレッドの外部でディスクまたはネットワークの I/O を実行する場合に適している。
- Default: メインスレッドの外部で CPU 負荷の高い作業を実行する場合に適している。
- UnConfined: 内部的に使用されており、通常は使用しない。
withContextでコンテキストを切り替えることができる。

コルーチンを直列で使う場合は、コンテキストの切り替え以外は気にしなくて良い。
並列で使用する場合は、並行性を構造化する必要がある。
並行性の構造化とは、並行処理の分岐と合流の範囲を明示すること。
明示するには、CoroutineScopeを使って子スコープを作る。
作らない場合、コルーチンの分岐中にエラーになった場合に親スコープ全体のエラーとなるため、try~catchで囲んでいてもcatchされない。